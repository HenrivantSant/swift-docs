(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{144:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return m}));var i=n(0),a=n.n(i);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var c=a.a.createContext({}),d=function(e){var t=a.a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=d(e.components);return a.a.createElement(c.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},b=a.a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,o=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),p=d(n),b=i,m=p["".concat(o,".").concat(b)]||p[b]||u[b]||r;return n?a.a.createElement(m,s(s({ref:t},c),{},{components:n})):a.a.createElement(m,s({ref:t},c))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=b;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var c=2;c<r;c++)o[c]=n[c];return a.a.createElement.apply(null,o)}return a.a.createElement.apply(null,n)}b.displayName="MDXCreateElement"},99:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return s})),n.d(t,"toc",(function(){return l})),n.d(t,"default",(function(){return d}));var i=n(3),a=n(7),r=(n(0),n(144)),o={title:"Basics"},s={unversionedId:"database/basics",id:"database/basics",isDocsHomePage:!1,title:"Basics",description:"The schema of the database is declared in Data Object in the code. Those objects will be referred to as Entities. Retrieving (querying) and persisting entities is done using the Swift\\Orm\\EntityManager.",source:"@site/docs/database/basics.md",slug:"/database/basics",permalink:"/swift-docs/docs/database/basics",editUrl:"https://github.com/SwiftAPI/swift-docs/tree/main/docs/database/basics.md",version:"current",sidebar:"docs",previous:{title:"Introduction",permalink:"/swift-docs/docs/database/introduction"},next:{title:"Cli",permalink:"/swift-docs/docs/database/cli"}},l=[{value:"Create, update, and delete",id:"create-update-and-delete",children:[{value:"Create",id:"create",children:[]},{value:"Update",id:"update",children:[]},{value:"Delete an entity",id:"delete-an-entity",children:[]}]},{value:"Direct database queries",id:"direct-database-queries",children:[]},{value:"Selecting data",id:"selecting-data",children:[]},{value:"Simple relation",id:"simple-relation",children:[{value:"Describe the entity",id:"describe-the-entity",children:[]},{value:"Persisting related entities",id:"persisting-related-entities",children:[]}]}],c={toc:l};function d(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(r.b)("wrapper",Object(i.a)({},c,n,{components:t,mdxType:"MDXLayout"}),Object(r.b)("p",null,"The schema of the database is declared in Data Object in the code. Those objects will be referred to as ",Object(r.b)("inlineCode",{parentName:"p"},"Entities"),". Retrieving (querying) and persisting entities is done using the ",Object(r.b)("inlineCode",{parentName:"p"},"Swift\\Orm\\EntityManager"),". "),Object(r.b)("h2",{id:"create-update-and-delete"},"Create, update, and delete"),Object(r.b)("p",null,"All persistence actions are done using the ",Object(r.b)("inlineCode",{parentName:"p"},"Swift\\Orm\\EntityManager"),"."),Object(r.b)("h3",{id:"create"},"Create"),Object(r.b)("p",null,"To create a new record of an entity, create a new class instance and add the values. After that persist the entity and run entity Manager."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-php"},"$movie = new Movie();\n$movie->setTitle( 'Foo bar' );\n$movie->setDescription( 'Movie about foo bar' );\n$movie->setReleased( new \\DateTime() );\n$movie->setType( ConditionTypeEnum::OUTSIDE_TEMP );\n\n$this->entityManager->persist( $movie );\n$this->entityManager->run();\n")),Object(r.b)("p",null,"In order to prevent the system from breaking, you might want to catch errors. "),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-php"},"try {\n    $this->entityManager->run();\n} catch ( \\Throwable $e ) {\n    // handle error\n}\n")),Object(r.b)("h3",{id:"update"},"Update"),Object(r.b)("p",null,"To be able to update an object, you must first query the object."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-php"},"$movie = $this->entityManager->findByPk( Movie::class, 1 );\n\n$movie->setDescription( 'Movie about hello foo' );\n\n$this->entityManager->persist( $movie );\n$this->entityManager->run();\n")),Object(r.b)("p",null,"By default the ORM will only update the fields that have changed. The given code would product SQL code like this:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-sql"},'UPDATE `movies`\nSET `description` = "Movie about hello foo"\nWHERE `id` = 1\n')),Object(r.b)("h3",{id:"delete-an-entity"},"Delete an entity"),Object(r.b)("p",null,"An entity can be deleted by calling the ",Object(r.b)("inlineCode",{parentName:"p"},"delete")," method on the EntityManager."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-php"},"$movie = $this->entityManager->findByPk( Movie::class, 1 );\n\n$this->entityManager->delete( $movie );\n$this->entityManager->run();\n")),Object(r.b)("p",null,"Please note, the ORM will not automatically trigger the delete operation for related entities and will rely on foreign key rules set in the database."),Object(r.b)("h2",{id:"direct-database-queries"},"Direct database queries"),Object(r.b)("p",null,"You can always talk to the database directly without using the ORM abstraction on top of it. You can do this by injecting the ",Object(r.b)("inlineCode",{parentName:"p"},"Swift\\Dbal\\Dbal")," service. This is a direct implementation of the ",Object(r.b)("inlineCode",{parentName:"p"},"Cycle\\Database\\DatabaseInterface"),"."),Object(r.b)("h2",{id:"selecting-data"},"Selecting data"),Object(r.b)("p",null,"The most common way to select data from the database is using the ",Object(r.b)("inlineCode",{parentName:"p"},"Swift\\Orm\\EntityManager"),". To use the entity manager you need to inject the ",Object(r.b)("inlineCode",{parentName:"p"},"Swift\\Orm\\EntityManager")," service."),Object(r.b)("p",null,"The Entity Manager provides multiple methods to select the entity."),Object(r.b)("p",null,"To find the entity using its primary key:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-php"},"$user = $entityManager->findByPk( Movie::class, 1 );\n")),Object(r.b)("p",null,"Null will be returned if the entity was not found."),Object(r.b)("p",null,"You can use default values in the query. Field names will automatically be converted to the correct database field name."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-php"},"$entity = $entityManager->findOneBy( Movie::class, [\n    'title' => 'Foo bar',\n    'type' => FooType::BAR,\n] );\n")),Object(r.b)("p",null,"More advanced queries can be created using the ",Object(r.b)("inlineCode",{parentName:"p"},"Swift\\Dbal\\Arguments\\Arguments"),". Custom Arguments can easily be used to create custom queries. An argument is a class implementing the ",Object(r.b)("inlineCode",{parentName:"p"},"Swift\\Dbal\\Arguments\\ArgumentInterface"),"."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-php"},"$arguments = ( new \\Swift\\Dbal\\Arguments\\Arguments() )\n        ->setOffset( 3 )\n        ->setLimit( 2 )\n        ->setOrderBy( 'title' )\n        ->setDirection( \\Swift\\Dbal\\Arguments\\ArgumentDirection::DESC )\n        ->addArgument( new \\Swift\\Dbal\\Arguments\\Where( 'title', \\Swift\\Dbal\\Arguments\\ArgumentComparison::CONTAINS, 'Foo' ) )\n        ->addArgument( new \\Swift\\Dbal\\Arguments\\Where( 'id', \\Swift\\Dbal\\Arguments\\ArgumentComparison::IN, [ 1, 3, 5 ] ) );\n    \n$this->entityManager->findMany( Movie::class, [], $arguments );\n")),Object(r.b)("p",null,"The method ",Object(r.b)("inlineCode",{parentName:"p"},"findMany")," will return an ",Object(r.b)("inlineCode",{parentName:"p"},"Swift\\Orm\\Dbal\\ResultCollectionInterface"),", which is an Iterator with some handy additional methods to aid in e.g. pagination."),Object(r.b)("h2",{id:"simple-relation"},"Simple relation"),Object(r.b)("p",null,"A significant part of the ORM is the ability to handle relations between objects. Relations are defined in the entity definition class using attributes."),Object(r.b)("h3",{id:"describe-the-entity"},"Describe the entity"),Object(r.b)("p",null,"Firstly we will have to create two entities we want to relate to one another. The first entity is called ",Object(r.b)("inlineCode",{parentName:"p"},"Movie")," and the second entity is called ",Object(r.b)("inlineCode",{parentName:"p"},"Actor"),"."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-php"},"<?php declare( strict_types=1 );\n\nnamespace App\\Foo\\Repository;\n\nuse Swift\\Orm\\Entity\\AbstractEntity;\nuse Swift\\Orm\\Attributes\\Entity;\nuse Swift\\Orm\\Attributes\\Field;\nuse Swift\\Orm\\Types\\FieldTypes;\n\n#[Entity( table: 'movies' )]\nclass Movie extends AbstractEntity {\n    \n    #[Field( name: 'id', primary: true, type: FieldTypes::INT, length: 11 )]\n    protected int $id;\n    \n    #[Field( name: 'title', type: FieldTypes::STRING, index: true, length: 128 )]\n    protected string $title;\n    \n    /**\n     * @return int\n     */\n    public function getId(): int {\n        return $this->id;\n    }\n    \n    /**\n     * @return string\n     */\n    public function getTitle(): string {\n        return $this->title;\n    }\n    \n    /**\n     * @param string $title\n     */\n    public function setTitle( string $title ): void {\n        $this->title = $title;\n    }\n    \n}\n")),Object(r.b)("p",null,"And the entity we want to define a relationship with."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-php"},"<?php declare( strict_types=1 );\n\nnamespace App\\Foo\\Repository;\n\nuse Swift\\Orm\\Entity\\AbstractEntity;\nuse Swift\\Orm\\Attributes\\Entity;\nuse Swift\\Orm\\Attributes\\Field;\nuse Swift\\Orm\\Collection\\ArrayCollection;\nuse Swift\\Orm\\Types\\FieldTypes;\n\n#[Entity( table: 'movie_actors' )]\nclass Actor extends AbstractEntity {\n    \n    #[Field( name: 'id', primary: true, type: FieldTypes::INT )]\n    protected int $id;\n    \n    #[Field( name: 'name', type: FieldTypes::STRING, length: 64 )]\n    protected string $name;\n\n    /**\n     * @return int\n     */\n    public function getId(): int {\n        return $this->id;\n    }\n    \n    /**\n     * @return string\n     */\n    public function getName(): string {\n        return $this->name;\n    }\n    \n    public function setName( string $name ): void {\n        $this->name = $name;\n    }\n    \n}\n")),Object(r.b)("p",null,"To relate our entities we have to add a new property to one of them and annotate it properly. We should also add getter and setter for this property."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-php"},"<?php declare( strict_types=1 );\n\nnamespace App\\Foo\\Repository;\n\nuse Swift\\Orm\\Entity\\AbstractEntity;\nuse Swift\\Orm\\Attributes\\Entity;\nuse Swift\\Orm\\Attributes\\Field;\nuse Swift\\Orm\\Attributes\\Relation\\ManyToMany;\nuse Swift\\Orm\\Collection\\ArrayCollection;\nuse Swift\\Orm\\Collection\\ArrayCollectionInterface;\nuse Swift\\Orm\\Types\\FieldTypes;\n\n#[Entity( table: 'movies' )]\nclass Movie extends AbstractEntity {\n    \n    #[ManyToMany( targetEntity: Actor::class )]\n    protected ArrayCollectionInterface $actors;\n    \n    public function __construct() {\n        $this->actors  = new ArrayCollection();\n    }\n    \n    /**\n     * @return \\Swift\\Orm\\Collection\\ArrayCollectionInterface\n     */\n    public function getActors(): ArrayCollectionInterface {\n        return $this->actors;\n    }\n    \n    /**\n     * @param \\App\\Foo\\Repository\\Actor $actor\n     */\n    public function addActor( Actor $actor ): void {\n        $actor->addMovie( $this );\n        $this->actors[] = $actor;\n    }\n    \n}\n")),Object(r.b)("p",null,"We can also refer to the other side of the relation. Because we already defined the relationship in the other entity we just read it, as it's already defined in this side of the relation automatically."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-php"},"<?php declare( strict_types=1 );\n\nnamespace App\\Foo\\Repository;\n\nuse Swift\\Orm\\Entity\\AbstractEntity;\nuse Swift\\Orm\\Attributes\\Entity;\nuse Swift\\Orm\\Attributes\\Field;\nuse Swift\\Orm\\Collection\\ArrayCollection;\nuse Swift\\Orm\\Types\\FieldTypes;\n\n#[Entity( table: 'movie_actors' )]\nclass Actor extends AbstractEntity {\n    \n    protected ArrayCollection $movies;\n    \n    public function __construct() {\n        $this->movies = new ArrayCollection();\n    }\n    \n    /**\n     * @return \\Swift\\Orm\\Collection\\ArrayCollection\n     */\n    public function getMovies(): ArrayCollection {\n        return $this->movies;\n    }\n    \n    public function addMovie( Movie $movie ): void {\n        $this->movies[] = $movie;\n    }\n    \n}\n")),Object(r.b)("h3",{id:"persisting-related-entities"},"Persisting related entities"),Object(r.b)("p",null,"Entities can have relations, embedded entities, and collections. Those are all handled by the ORM."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-php"},"$movie = new Movie();\n$movie->setTitle( 'Foo bar' );\n$movie->setDescription( 'Movie about foo bar' );\n$movie->setReleased( new \\DateTime() );\n$movie->setType( ConditionType::OUTSIDE_TEMP );\n\n$embed = new MovieEmbed();\n$embed->setTest( 'test' );\n$embed->setViewers( 123 );\n$movie->setEmbed( $embed );\n\n$actor = new Actor();\n$actor->setName( 'David Johnson' );\n$movie->addActor( $actor );\n$actor2 = new Actor();\n$actor2->setName( 'Davina Wheeler' );\n$movie->addActor( $actor2 );\n$actor3 = new Actor();\n$actor3->setName( 'Greg Scott' );\n$movie->addActor( $actor3 );\n\n$user   = $this->entityManager->findByPK( UserEntity::class, 1 );\n$review = new Review();\n$review->setContent( 'Loving this movie!!' );\n$review->setMovie( $movie );\n$review->setUser( $user );\n$movie->addReview( $review );\n$review1 = new Review();\n$review1->setContent( 'Great talent in this movie!' );\n$review1->setMovie( $movie );\n$review1->setUser( $user );\n$movie->addReview( $review1 );\n\n$this->entityManager->persist( $movie );\n$this->entityManager->run();\n")))}d.isMDXComponent=!0}}]);