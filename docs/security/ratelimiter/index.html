<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.72">
<link rel="alternate" type="application/rss+xml" href="/swift-docs/blog/rss.xml" title="Swift API Framework Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/swift-docs/blog/atom.xml" title="Swift API Framework Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Swift API Framework" href="/swift-docs/opensearch.xml"><title data-react-helmet="true">Rate Limiter | Swift API Framework</title><meta data-react-helmet="true" property="og:url" content="https://swiftapi.github.io/swift-docs/docs/security/ratelimiter"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Rate Limiter | Swift API Framework"><meta data-react-helmet="true" name="description" content="The rate limiter is responsible for limiting the rate of requests a user can make to the application within a given time period. This is useful for preventing a user from spamming the application, but mainly to control the amount of requests a user is allowed to make. The rate limiter is configured in the etc/config/security.yaml file."><meta data-react-helmet="true" property="og:description" content="The rate limiter is responsible for limiting the rate of requests a user can make to the application within a given time period. This is useful for preventing a user from spamming the application, but mainly to control the amount of requests a user is allowed to make. The rate limiter is configured in the etc/config/security.yaml file."><link data-react-helmet="true" rel="shortcut icon" href="/swift-docs/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://swiftapi.github.io/swift-docs/docs/security/ratelimiter"><link data-react-helmet="true" rel="alternate" href="https://swiftapi.github.io/swift-docs/docs/security/ratelimiter" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://swiftapi.github.io/swift-docs/docs/security/ratelimiter" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://YWHKNR9J2V-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/swift-docs/assets/css/styles.420a0495.css">
<link rel="preload" href="/swift-docs/assets/js/styles.a335f3d3.js" as="script">
<link rel="preload" href="/swift-docs/assets/js/runtime~main.8b17c7aa.js" as="script">
<link rel="preload" href="/swift-docs/assets/js/main.302c97ce.js" as="script">
<link rel="preload" href="/swift-docs/assets/js/1.7eadec3d.js" as="script">
<link rel="preload" href="/swift-docs/assets/js/2.9eda4aa2.js" as="script">
<link rel="preload" href="/swift-docs/assets/js/3.a0a824ba.js" as="script">
<link rel="preload" href="/swift-docs/assets/js/1be78505.79f3bd1a.js" as="script">
<link rel="preload" href="/swift-docs/assets/js/935f2afb.276a3bef.js" as="script">
<link rel="preload" href="/swift-docs/assets/js/17896441.1a7ad218.js" as="script">
<link rel="preload" href="/swift-docs/assets/js/f92b3b5d.58d9440b.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/swift-docs/"><img src="/swift-docs/img/logo.svg" alt="Swift Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/swift-docs/img/logo.svg" alt="Swift Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Swift</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/swift-docs/docs/">Docs</a><a class="navbar__item navbar__link" href="/swift-docs/next">Next</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/SwiftAPI/swift" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_GrZ2"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/swift-docs/"><img src="/swift-docs/img/logo.svg" alt="Swift Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/swift-docs/img/logo.svg" alt="Swift Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Swift</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/swift-docs/docs/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/swift-docs/next">Next</a></li><li class="menu__list-item"><a href="https://github.com/SwiftAPI/swift" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper main-docs-wrapper"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Getting started</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/getting-started/installation">Installation</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Architecture</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/architecture/introduction">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/architecture/application-lifecycle">Application lifecycle</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/architecture/attributes">Attributes</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/swift-docs/docs/middleware">Middleware</a></li><li class="menu__list-item"><a class="menu__link" href="/swift-docs/docs/command-line-interface">Command line interface</a></li><li class="menu__list-item"><a class="menu__link" href="/swift-docs/docs/configuration">Configuration</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Database</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/database/introduction">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/database/basics">Basics</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/database/cli">Cli</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/database/entities">Entities</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/database/relations">Relations</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/database/entity-behaviors">Entity Behaviors</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/database/lifecycles">Lifecycles</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/database/driver">Driver</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/swift-docs/docs/dependency-injection">Dependency Injection</a></li><li class="menu__list-item"><a class="menu__link" href="/swift-docs/docs/events-and-subscribers">Events, Subscribers &amp; Listeners</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">GraphQl</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/graphql/introduction">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/graphql/configuration">Configuration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/graphql/generators">Generators</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/graphql/builder">Builder</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/graphql/middleware">Middleware</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/graphql/resolvers">Resolvers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/graphql/schema">Schema</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/graphql/tools">Tools</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/graphql/relay">Relay</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/graphql/security">Security</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/swift-docs/docs/httpfoundation">HTTP Foundation</a></li><li class="menu__list-item"><a class="menu__link" href="/swift-docs/docs/logging">Logging</a></li><li class="menu__list-item"><a class="menu__link" href="/swift-docs/docs/making-requests">Making requests</a></li><li class="menu__list-item"><a class="menu__link" href="/swift-docs/docs/routing-and-controllers">Routing &amp; Controllers</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Security</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/swift-docs/docs/security/introduction">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/swift-docs/docs/security/authentication">Authentication</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/swift-docs/docs/security/authorization">Authorization</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/swift-docs/docs/security/firewall">Firewall</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/swift-docs/docs/security/ratelimiter">Rate Limiter</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/swift-docs/docs/security/users">Users (&amp; Clients)</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Runtime</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/runtime/introduction">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/runtime/configuration">Configuration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/runtime/cron">Cron</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/runtime/coroutines">Coroutines</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/runtime/websockets">WebSocket</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/swift-docs/docs/runtime/filewatcher">FileWatcher</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">Rate Limiter</h1></header><div class="markdown"><p>The rate limiter is responsible for limiting the rate of requests a user can make to the application within a given time period. This is useful for preventing a user from spamming the application, but mainly to control the amount of requests a user is allowed to make. The rate limiter is configured in the <code>etc/config/security.yaml</code> file.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">rate_limit</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">enable_default</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">default_limit</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">default_period</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">60</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">default_strategy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> sliding_window</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">rates</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> foo_bar</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token key atrule">strategy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> sliding_window</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token key atrule">limit</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">30</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token key atrule">period</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">60</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Rate limits are measured using a <a href="https://en.wikipedia.org/wiki/Token_bucket#:~:text=The%20token%20bucket%20is%20an,variations%20in%20the%20traffic%20flow" target="_blank" rel="noopener noreferrer">token bucket algorithm</a>. The limit is the maximum number of tokens that can be stored in the bucket. The period is the time in seconds that the bucket is allowed to hold tokens. The strategy is the algorithm used to determine the number of tokens that are added to the bucket.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="default-rate-limiter"></a>Default Rate Limiter<a class="hash-link" href="#default-rate-limiter" title="Direct link to heading">#</a></h2><p>The default rate limiter limits all incoming requests as configured. The <code>Swift\Security\RateLimiter\Kernel\Middleware\RateLimitingMiddleware</code> middleware is responsible for adding the default rate limiter to the request. The default_limit, default_period and default_strategy are configured in the <code>etc/config/security.yaml</code> file. Default rate limiter is disabled by default. To enable it, set <code>default_enabled: true</code> in the <code>rate_limit</code> section. </p><p>By default, each request consumes one token. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="graphql-rate-limiter"></a>GraphQL Rate Limiter<a class="hash-link" href="#graphql-rate-limiter" title="Direct link to heading">#</a></h3><p>GraphQl requests consume at least one token, however this is calculated based on the complexity of the query. The complexity of the query is determined by the number of fields in the query divided by 100. For example, a query with 100 fields will consume 1 token. A query with 200 fields will consume 2 tokens. The minimum is 1 token. A query with 170 fields, will consume 2 tokens (170 / 100 = 1.7). This will round off at 2 tokens.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="custom-rate-limiter"></a>Custom Rate Limiter<a class="hash-link" href="#custom-rate-limiter" title="Direct link to heading">#</a></h2><p>There&#x27;s a dozen of reasons to use a custom rate limiter. The most common is to limit the rate of requests to a specific endpoint, or you might want to limit the rate of requests to a specific user. You can still combine this with the default rate limiter. An example of this is Login throttling.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="configuration"></a>Configuration<a class="hash-link" href="#configuration" title="Direct link to heading">#</a></h3><p>The easiest way to configure a custom rate limiter is to add a new rate to the <code>rates</code> array in the <code>rate_limit</code> section of the <code>etc/config/security.yaml</code> file.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">rates</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> foo_bar</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token key atrule">strategy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> sliding_window</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token key atrule">limit</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">30</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token key atrule">period</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">60</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The RateLimiterFactory will now look for a rate with the name <code>foo_bar</code> and return a RateLimiter configured as such. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="rate-limiter-configuration-factory"></a>Rate Limiter Configuration Factory<a class="hash-link" href="#rate-limiter-configuration-factory" title="Direct link to heading">#</a></h3><p>The RateLimiterConfigurationFactory is responsible for creating RateLimiterConfigurationInterface instances. These represent the configuration for a rate limiter.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="example"></a>Example<a class="hash-link" href="#example" title="Direct link to heading">#</a></h4><p>This example shows how Swift uses the RateLimiterConfigurationFactory to create a RateLimiterConfigurationInterface instance for the custom configured rate limiter through configuration.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly php"><div tabindex="0" class="prism-code language-php codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;?php declare( strict_types=1 );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace Swift\Security\RateLimiter\Factory;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">use Swift\DependencyInjection\Attributes\Autowire;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[Autowire]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">class ConfigurationFactory implements \Swift\Security\RateLimiter\Factory\RateLimiterConfigurationFactoryInterface {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public function __construct(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        protected \Swift\Configuration\ConfigurationInterface $configuration,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public function create( string $name, string $stateId ): ?RateLimiterConfigurationInterface {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $config = $this-&gt;configuration-&gt;get( &#x27;rate_limit.rates&#x27;, &#x27;security&#x27; );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if ( ! isset( $config[ $name ] ) ) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return new RateLimiterConfiguration(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $name,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $config[ $name ][ &#x27;strategy&#x27; ],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $stateId,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $config[ $name ][ &#x27;limit&#x27; ],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            new \DateInterval( &#x27;PT&#x27; . $config[ $name ][ &#x27;period&#x27; ] . &#x27;S&#x27; ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="rate-limiter-factory"></a>Rate Limiter Factory<a class="hash-link" href="#rate-limiter-factory" title="Direct link to heading">#</a></h3><p>The RateLimiterFactory is responsible for creating RateLimiterInterface instances based on the RateLimiterConfigurationInterface.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="example-1"></a>Example<a class="hash-link" href="#example-1" title="Direct link to heading">#</a></h4><p>This example shows how Swift uses the RateLimiterFactory to create a RateLimiterInterface instance.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly php"><div tabindex="0" class="prism-code language-php codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;?php declare( strict_types=1 );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace Swift\Security\RateLimiter\Strategy;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">use Swift\DependencyInjection\Attributes\Autowire;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">use Swift\Security\RateLimiter\Factory\RateLimiterConfigurationInterface;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">use Swift\Security\RateLimiter\RateLimiterInterface;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">use Swift\Security\RateLimiter\Storage\DatabaseTokenStorage;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[Autowire]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">class CoreStrategyFactory implements RateLimiterStrategyFactoryInterface {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public function __construct(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        protected DatabaseTokenStorage $databaseTokenStorage,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public function create( RateLimiterConfigurationInterface $configuration ): ?RateLimiterInterface {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return match ( $configuration-&gt;getStrategy() ) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            SlidingWindowStrategy::NAME, SlidingWindowStrategy::class =&gt; new SlidingWindowStrategy(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                $configuration-&gt;getName(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                $configuration-&gt;getStateId(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                $configuration-&gt;getLimit(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                $configuration-&gt;getInterval(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                $this-&gt;databaseTokenStorage,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            default =&gt; null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="token-storage"></a>Token storage<a class="hash-link" href="#token-storage" title="Direct link to heading">#</a></h3><p>The TokenStorage is responsible for storing and fetching token buckets. By default, the TokenStorage is a DatabaseTokenStorage, but a custom TokenStorage can be used.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="example-2"></a>Example<a class="hash-link" href="#example-2" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly php"><div tabindex="0" class="prism-code language-php codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;?php declare( strict_types=1 );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace Swift\Security\RateLimiter\Storage;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">use Swift\DependencyInjection\Attributes\Autowire;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">use Swift\Security\RateLimiter\TokenBucketInterface;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[Autowire]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">class DatabaseTokenStorage implements StorageInterface {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public function __construct(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        protected \Swift\Orm\EntityManagerInterface $entityManager,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public function persist( TokenBucketInterface $tokenBucket ): void {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        foreach ( $tokenBucket-&gt;getTokens() as $token ) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $this-&gt;entityManager-&gt;persist( $token );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $this-&gt;entityManager-&gt;run();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public function fetch( string $name, string $stateId ): ?TokenBucketInterface {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $tokens = $this-&gt;entityManager-&gt;findMany( LimiterTokenEntity::class, [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &#x27;rateName&#x27; =&gt; $name,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &#x27;stateId&#x27;  =&gt; $stateId,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ] );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return new DatabaseTokenBucket( $name, $stateId, $tokens );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public function reset( string $name, string $stateId, ?\DateTimeInterface $before = null ): void {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $tokens = $this-&gt;entityManager-&gt;findMany( LimiterTokenEntity::class, [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &#x27;rateName&#x27; =&gt; $name,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &#x27;stateId&#x27;  =&gt; $stateId,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ] );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        foreach ( $tokens as $token ) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if ( ( $before !== null ) &amp;&amp; ( $token-&gt;getCreatedAt() &gt; $before ) ) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                continue;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $this-&gt;entityManager-&gt;delete( $token );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $this-&gt;entityManager-&gt;run();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="strategy"></a>Strategy<a class="hash-link" href="#strategy" title="Direct link to heading">#</a></h3><p>The Strategy is responsible for calculating the number of tokens to consume. The default strategy is the SlidingWindowStrategy. A custom strategy can be used by implementing the <code>Swift\Security\RateLimiter\RateLimiterInterface</code>. And defining a factory for initializing the strategy, like the CoreStrategyFactory above.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="strategy-1"></a>Strategy<a class="hash-link" href="#strategy-1" title="Direct link to heading">#</a></h2><p>Strategies are responsible for calculating the number of tokens over a period of time. The default strategy is the SlidingWindowStrategy. This is the strategy that Swift uses by default and is the most common strategy. However, you can create your own strategy and use it by implementing the <code>Swift\Security\RateLimiter\RateLimiterInterface</code>. An example of another strategy is the FixedWindowStrategy.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="sliding-window"></a>Sliding window<a class="hash-link" href="#sliding-window" title="Direct link to heading">#</a></h3><p>The SlidingWindowStrategy calculated the number of available tokens based on how many tokens were consumed between the moment of the request and the moment of the request minus the interval.</p><p>For example, if a request is made at time <code>t</code> and the interval is <code>1 minute</code>. The strategy will fetch all tokens created between <code>t - 1 minute</code> and <code>t</code>. It will now withdraw those tokens from the limit and return the number of tokens that can still be consumed.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="usage"></a>Usage<a class="hash-link" href="#usage" title="Direct link to heading">#</a></h2><p>Interaction with the Rate Limiter is done through the <code>Swift\Security\RateLimiter\RateLimiterFactory</code>. The RateLimiterFactory is responsible for creating RateLimiterInterface instances.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="example-of-usage-in-middleware"></a>Example of usage in middleware<a class="hash-link" href="#example-of-usage-in-middleware" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly php"><div tabindex="0" class="prism-code language-php codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;?php declare( strict_types=1 );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace Swift\Security\RateLimiter\Kernel\Middleware;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">use Swift\Configuration\ConfigurationInterface;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">use Swift\DependencyInjection\Attributes\Autowire;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">use Swift\Kernel\Middleware\KernelMiddlewareOrder;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">use Swift\Kernel\Middleware\MiddlewareInterface;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">use Swift\Security\RateLimiter\RateLimit;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">use Swift\Security\RateLimiter\RateLimiterFactory;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[Autowire]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">class RateLimitingMiddleware implements MiddlewareInterface {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public function __construct(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        protected RateLimiterFactory     $rateLimiterFactory,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        protected ConfigurationInterface $configuration,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public function getOrder(): int {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return KernelMiddlewareOrder::RATE_LIMIT;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public function process(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        \Psr\Http\Message\ServerRequestInterface $request,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        \Psr\Http\Server\RequestHandlerInterface $handler,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ): \Psr\Http\Message\ResponseInterface {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // If rate limiting is disabled, skip this middleware</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if ( ! $this-&gt;configuration-&gt;get( &#x27;rate_limit.enabled&#x27;, &#x27;security&#x27; ) ) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return $handler-&gt;handle( $request );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // If this is a GraphQL request, skip this middleware. GraphQL rate limiting is handled by the QueryComplexityRateLimiter rule.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if ( \Swift\GraphQl\Util::isGraphQlRequest( $request ) ) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return $handler-&gt;handle( $request );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if ( $this-&gt;configuration-&gt;get(&#x27;rate_limit.enable_default&#x27;, &#x27;security&#x27;) ) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Returns a RateLimiterInterface of null if no rate limiter is found.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // The utility will automatically fetch a state id, for non-authenticated requests it will use the IP address, for authenticated requests it will use the user uuid.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $limiter = $this-&gt;rateLimiterFactory-&gt;create( &#x27;default&#x27;, \Swift\Security\RateLimiter\Util::getStateFromRequest( $request ) );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // This will return a Swift\Security\RateLimiter\RateLimit object.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $rate = $limiter?-&gt;consume( 1 );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // This will throw a Swift\HttpFoundation\Exception\TooManyRequestsException if the rate limit is exceeded.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // The Kernel will handle this exception and return a 429 response.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $rate-&gt;denyIfNotAccepted();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Another option is to manually check if the rate limit is exceeded.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // if ( $rate-&gt;isAccepted() ) { // rate limit is not exceeded }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $response = $handler-&gt;handle( $request );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // RateLimiter::bindToResponse will add the X-RateLimit-Limit, X-RateLimit-Remaining and X-RateLimit-Reset headers to the response.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return RateLimit::bindToResponse( $rate ?? null, $response );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="example-of-usage-in-eventsubscriber"></a>Example of usage in EventSubscriber<a class="hash-link" href="#example-of-usage-in-eventsubscriber" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly php"><div tabindex="0" class="prism-code language-php codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;?php declare( strict_types=1 );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace Swift\Security\Firewall\EventSubscriber;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">use Swift\DependencyInjection\Attributes\Autowire;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">use Swift\Security\Firewall\Exception\LoginThrottlingTooManyAttempts;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">use Swift\Security\User\Authentication\Passport\Stamp\LoginStamp;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[Autowire]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">class CheckPassportSubscriber implements \Swift\Events\EventSubscriberInterface {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public function __construct(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        protected \Swift\Security\RateLimiter\RateLimiterFactory $rateLimiterFactory,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /**</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     * @inheritDoc</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static function getSubscribedEvents(): array {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            \Swift\Security\Authentication\Events\CheckPassportEvent::class =&gt; [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &#x27;loginThrottling&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /**</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     * Validate the login throttling.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     *</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     * @param \Swift\Security\Authentication\Events\CheckPassportEvent $event</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     *</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     * @return void</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public function loginThrottling( \Swift\Security\Authentication\Events\CheckPassportEvent $event ): void {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if ( ! $event-&gt;getPassport()-&gt;hasStamp( LoginStamp::class ) ) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $limiter = $this-&gt;rateLimiterFactory-&gt;create( &#x27;login_throttling&#x27;, $event-&gt;getPassport()-&gt;getUser()-&gt;getUuid() );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $rate    = $limiter?-&gt;consume();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if ( ! $rate-&gt;isAccepted() ) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            throw new LoginThrottlingTooManyAttempts( $rate );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="rate-limiter-http-headers"></a>Rate Limiter HTTP Headers<a class="hash-link" href="#rate-limiter-http-headers" title="Direct link to heading">#</a></h3><p>It is good practice to add the rate limiter headers to the response. This is easily done by using the RateLimiter::bindToResponse method. Like in the example above, the RateLimiter::bindToResponse method will add the X-RateLimit-Limit, X-RateLimit-Remaining and X-RateLimit-Reset headers to the response.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly php"><div tabindex="0" class="prism-code language-php codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">/**</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * Binds rate limit headers to a response.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> *</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * @param \Swift\Security\RateLimiter\RateLimitInterface|null $rateLimit</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * @param \Psr\Http\Message\ResponseInterface                 $response</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> *</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * @return \Psr\Http\Message\ResponseInterface</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public static function bindToResponse( ?RateLimitInterface $rateLimit, ResponseInterface $response ): ResponseInterface {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if ( ! $rateLimit ) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return $response;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return $response-&gt;withHeader( &#x27;X-RateLimit-Limit&#x27;, $rateLimit-&gt;getLimit() )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    -&gt;withHeader( &#x27;X-RateLimit-Remaining&#x27;, $rateLimit-&gt;getAvailableTokens() )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    -&gt;withHeader( &#x27;X-RateLimit-Reset&#x27;, $rateLimit-&gt;getResetTime()-&gt;getTimestamp() );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/SwiftAPI/swift-docs/tree/main/docs/security/ratelimiter.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/swift-docs/docs/security/firewall"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Firewall</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/swift-docs/docs/security/users"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Users (&amp; Clients) Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#default-rate-limiter" class="table-of-contents__link">Default Rate Limiter</a><ul><li><a href="#graphql-rate-limiter" class="table-of-contents__link">GraphQL Rate Limiter</a></li></ul></li><li><a href="#custom-rate-limiter" class="table-of-contents__link">Custom Rate Limiter</a><ul><li><a href="#configuration" class="table-of-contents__link">Configuration</a></li><li><a href="#rate-limiter-configuration-factory" class="table-of-contents__link">Rate Limiter Configuration Factory</a></li><li><a href="#rate-limiter-factory" class="table-of-contents__link">Rate Limiter Factory</a></li><li><a href="#token-storage" class="table-of-contents__link">Token storage</a></li><li><a href="#strategy" class="table-of-contents__link">Strategy</a></li></ul></li><li><a href="#strategy-1" class="table-of-contents__link">Strategy</a><ul><li><a href="#sliding-window" class="table-of-contents__link">Sliding window</a></li></ul></li><li><a href="#usage" class="table-of-contents__link">Usage</a><ul><li><a href="#example-of-usage-in-middleware" class="table-of-contents__link">Example of usage in middleware</a></li><li><a href="#example-of-usage-in-eventsubscriber" class="table-of-contents__link">Example of usage in EventSubscriber</a></li><li><a href="#rate-limiter-http-headers" class="table-of-contents__link">Rate Limiter HTTP Headers</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/swift-docs/docs/">Getting Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/swift-api" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/swift-docs/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/SwiftAPI/swift" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Swift. Built with Docusaurus.</div></div></div></footer></div>
<script src="/swift-docs/assets/js/styles.a335f3d3.js"></script>
<script src="/swift-docs/assets/js/runtime~main.8b17c7aa.js"></script>
<script src="/swift-docs/assets/js/main.302c97ce.js"></script>
<script src="/swift-docs/assets/js/1.7eadec3d.js"></script>
<script src="/swift-docs/assets/js/2.9eda4aa2.js"></script>
<script src="/swift-docs/assets/js/3.a0a824ba.js"></script>
<script src="/swift-docs/assets/js/1be78505.79f3bd1a.js"></script>
<script src="/swift-docs/assets/js/935f2afb.276a3bef.js"></script>
<script src="/swift-docs/assets/js/17896441.1a7ad218.js"></script>
<script src="/swift-docs/assets/js/f92b3b5d.58d9440b.js"></script>
</body>
</html>